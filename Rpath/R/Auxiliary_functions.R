#'Mixed Trophic Impacts
#'
#'Need to edit.
#'
#'@family Rpath functions
#'
#'@param Rpath Balanced Rpath model generated by rpath.
#'@param Rpath.params R object containing the Rpath parameters.  This is generated
#'  either by the create.rpath.params or read.rpath.params functions.
#'@param increase Logical value indicating whether a marginal increase is applied.
#'
#'@return Returns a matrix of mixed trophic impacts.
#'@export 
MTI <- function(Rpath, Rpath.params, increase = T){
  x <- copy(Rpath.params)
  y <- copy(Rpath)
  
  #MTI is a matrix where MTIij = DCij - FCji
  
  #DCij
  DC <- as.data.table(x$diet)
  #Remove import and re-standardize remaining DC
  DC.cols <- names(DC)[which(names(DC) != 'Group')]
  DC <- DC[Group != 'Import']
  DC.colsum <- DC[, colSums(.SD, na.rm = T), .SDcols = DC.cols]
  for(icol in 1:length(DC.cols)){
    if(DC.colsum[icol] != 1){
      DC[, icol + 1 := .SD/DC.colsum[icol], .SDcols = DC.cols[icol]]
    }
  }
  #Add detritus columns
  n.detritus <- length(which(x$model$Type == 2))
  det.cols <- matrix(rep(0, n.detritus * nrow(DC)), nrow(DC), n.detritus)
  DC <- cbind(DC, det.cols)
  
  #Calculate proportion of catch for fishing "DC"
  totcatch <- y$Catch + y$Discards
  totcatch.sum <- colSums(totcatch)
  totcatch.prop <- c()
  for(icol in 1:ncol(totcatch)){
    fleet.prop <- totcatch[, icol] / totcatch.sum[icol]
    totcatch.prop <- cbind(totcatch.prop, fleet.prop)
  }
  #Add fleet "DC" to DC
  #Remove fleet rows from fleet DC
  ngroup <- length(x$model$Group[which(x$model$Type != 3)])
  fleet.DC <- totcatch.prop[1:ngroup, ]
  DC <- cbind(DC, fleet.DC)
  
  #Remove Group names
  DC[, Group := NULL]
  
  #Convert NAs to 0
  DC[is.na(DC)] <- 0
  
  #FCji - Proportion of predation on j from predator i
  #Calculate F mortality
  Fmort    <- as.data.frame(totcatch / y$BB[row(as.matrix(totcatch))])
  Fmort <- Fmort[1:ngroup, ]
  
  #Calculate M2
  bio  <- y$BB[1:y$NUM_LIVING]
  BQB  <- bio * y$QB[1:y$NUM_LIVING]
  diet <- as.data.frame(y$DC)
  nodetrdiet <- diet[1:y$NUM_LIVING, ]
  detrdiet   <- diet[(y$NUM_LIVING +1):ngroup, ]
  newcons    <- nodetrdiet * BQB[col(as.matrix(nodetrdiet))]
  predM      <- newcons / bio[row(as.matrix(newcons))]
  detcons    <- detrdiet * BQB[col(as.matrix(detrdiet))]
  predM      <- rbind(predM, detcons)
  setnames(predM, paste('V',  1:y$NUM_LIVING,    sep = ''),
           paste('M2.', y$Group[1:y$NUM_LIVING], sep = ''))
  
  FC <- as.data.table(cbind(predM, Fmort))
  
  #Convert to proportions of total mortality
  FC[, mort.sum := rowSums(.SD), .SDcols = names(FC)]
  FC <- FC[, .SD / mort.sum, .SDcols = names(FC)]
  FC[, mort.sum := NULL]
  
  #Merge pred and prey
  MTI <- as.matrix(DC - FC)
  
  #Add small increase
  if(increase == T){
    MTI.diag <- diag(MTI) + 1
  }else{
    MTI.diag <- diag(MTI) - 1
  }
  
  diag(MTI) <- MTI.diag
  
  #Inverse
  out <- MASS::ginv(MTI)
  
  return(out)
}






