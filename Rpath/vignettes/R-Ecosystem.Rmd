---
title: "R Ecosystem"
author: "Sean M. Lucey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R Ecosystem}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Rpath is an implementation of the ecosystem model Ecopath with Ecosim (EwE; 
Christensen and Pauly 1992^[Christensen and Pauly. 1992. ECOPATH II - a software
for balancing steady-state models and calculating network characteristics. 
Ecological Modelling 61:169-85], Walters et al. 1997^[Walters et al. 1997. 
Structuring dynamic models of exploited ecosystems from trophic mass-balance 
assessments. Reviews of Fish Biology and Fisheries 7:1-34]).  This vignette 
describes some of the basic functionality of the package using a fictional 
ecosystem, R Ecosystem.  Any resemblance to an actual ecosystem is purely 
coincidental.  To see the underlying mathematics please refer to Lucey et al. 
(in prep^[Lucey et al. in prep. Improving the EBFM toolbox with an alternative 
open source version of Ecopath with Ecosim]).

```{r rpath load, echo = F}
knitr::opts_chunk$set(
  comment = '#>',
  collapse = T)
library(Rpath)
````

## Setting up Ecopath

### Parameter file generation
Unlike the GUI based EwE software package, Rpath relies on a series of parameter
files.  A skeleton for a parameter file can be created using the function 
`create.rpath.param`.  Once created, it can be populated either within R or an 
external spreadsheet software such as Excel.  There are four different parameter
files: model, diet, juvenile, and pedigree.  The function `create.rpath.param`
can generate any of the four by setting the argument "parameter" to the desired 
type.  The parameter files do not need to be generated by `create.rpath.param` in
order to work with the model but this function can be helpful to ensure that all 
of the correct columns are in the appropriate parameter files.

#### Model parameter file
The data entered in the model parameter file are similar to the data entered in the 
input data tabs in EwE.  The model parameter file contains all of the biomass, 
production to biomass, consumption to biomass, etc. parameters as well as the detrital 
fate parameters and fleet landings and discards. The `create.rpath.param` function 
requires a vector of group names and a vector of their corresponding type (Living = 0, 
Primary Producer = 1, Detritus = 2, Fleet = 3).

```{r groups}
#Groups and types for the R Ecosystem

groups <- c('Seabirds', 'Whales', 'Seals', 'JuvRoundfish1', 'AduRoundfish1', 
            'JuvRoundfish2', 'AduRoundfish2', 'JuvFlatfish1', 'AduFlatfish1',
            'JuvFlatfish2', 'AduFlatfish2', 'OtherGroundfish', 'Foragefish1',
            'Foragefish2', 'OtherForagefish', 'Megabenthos', 'Shellfish',
            'Macrobenthos', 'Zooplankton', 'Phytoplankton', 'Detritus', 
            'Discards', 'Trawlers', 'Midwater', 'Dredgers')

types  <- c(rep(0, 19), 1, rep(2, 2), rep(3, 3))

modfile <- create.rpath.param(parameter = 'model', group = groups, type = types)
```

```{r blank modfile table, echo=FALSE, results='asis'}
knitr::kable(modfile, caption = 'Example table created using the 
             `create.rpath.param` function')
```

Note there is the option to save the parameter file by passing a name to the 
"filename" argument.  Each of the parameter files are created as data tables.
Data tables are an extension of the classic data frame class.  They allow for 
simplified indexing which can help populate the files in R.  For example you can
add data to a specific slot or fill an entire column.

```{r How to fill}
#Example of filling specific slots
modfile <- modfile[Group %in% c('Seals', 'Megabenthos'), EE := 0.8]

#Example of filling an entire column
biomass <- c(0.0149, 0.454, NA, 0.130, 1.39, 1.233, 5.553, 0.070, 5.766, 0.096,
             0.739, 7.4, 5.1, 4.7, 5.1, NA, 7, 17.4, 23, 10, rep(NA, 5))
modfile <- modfile[, Biomass := biomass]

```

Note the use of the operator ':=' to assign values.  This is unique to data tables.

```{r Modfile Table partial, echo = F}
knitr::kable(modfile[, list(Group, Type, Biomass, EE)], 
             caption = 'Example of assigning a specific slot or a whole column')

```

Here is the completed model parameter file for R Ecosystem:

```{r Fill Modfile}
#PB and QB
pb <- c(0.098, 0.031, 0.100, 2.026, 0.42, 2.1, 0.425, 1.5, 0.26, 1.1, 0.18, 0.6,
        0.61, 0.65, 1.5, 0.9, 1.3, 7, 39, 240, rep(NA, 5))
qb <- c(76.750, 6.976, 34.455, 8.414, 2.19, 10.94, 3.78, 8.008, 1.44, 5.839, 1.69,
        1.764, 3.52, 5.65, 3.6, 2.984, rep (NA, 9))
modfile <- modfile[, PB := pb]
modfile <- modfile[, QB := qb]

#Production to Consumption for those groups without a QB
modfile <- modfile[Group %in% c('Shellfish', 'Zooplankton'), ProdCons:= 0.25]
modfile <- modfile[Group == 'Macrobenthos', ProdCons := 0.35]

#Biomass accumulation and unassimilated production
modfile <- modfile[, BioAcc  := c(rep(0, 22), rep(NA, 3))]
modfile <- modfile[, Unassim := c(rep(0.2, 18), 0.4, rep(0, 3), rep(NA, 3))]

#Detrital Fate
modfile <- modfile[, Detritus := c(rep(1, 20), rep(0, 5))]
modfile <- modfile[, Discards := c(rep(0, 22), rep(1, 3))]

#Fisheries
#Landings
trawl  <- c(rep(0, 4), 0.08, 0, 0.32, 0, 0.09, 0, 0.05, 0.2, rep(0, 10), rep(NA, 3))
mid    <- c(rep(0, 12), 0.3, 0.08, 0.02, rep(0, 7), rep(NA, 3))
dredge <- c(rep(0, 15), 0.1, 0.5, rep(0, 5), rep(NA, 3))
modfile <- modfile[, Trawlers := trawl]
modfile <- modfile[, Midwater := mid]
modfile <- modfile[, Dredgers := dredge]

#Discards
trawl.d  <- c(1e-5, 1e-7, 0.001, 0.001, 0.005, 0.001, 0.009, 0.001, 0.04, 0.001,
              0.01, 0.08, 0.001, 0.001, 0.001, rep(0, 7), rep(NA, 3))
mid.d    <- c(rep(0, 2), 0.001, 0.001, 0.01, 0.001, 0.01, rep(0, 4), 0.05, 0.05,
              0.01, 0.01, rep(0, 7), rep(NA, 3))
dredge.d <- c(rep(0, 3), 0.001, 0.05, 0.001, 0.05, 0.001, 0.05, 0.001, 0.01, 0.05,
              rep(0, 3), 0.09, 0.01, 1e-4, rep(0, 4), rep(NA, 3))
modfile <- modfile[, Trawlers.disc := trawl.d]
modfile <- modfile[, Midwater.disc := mid.d]
modfile <- modfile[, Dredgers.disc := dredge.d]
```
```{r Modfile Table, echo = F}
knitr::kable(modfile, caption = 'Model Parameter file for R Ecosystem')
```


#### Diet parameter file

The data entered in the diet parameter file is the same as the data entered in the 
diet composition tab in EwE. Once again, `create.rpath.param` will generate a 
skeleton of the diet parameter file using a vector of group names and types as 
well as setting the argument 'parameter' to 'diet'.  Just as within EwE, the columns 
represent the predators while the rows represent the prey.

```{r initial dietfile}
dietfile <- create.rpath.param(parameter = 'diet', group = groups, type = types)
```
```{r blank dietfile table, echo = F}
knitr::kable(dietfile, caption = 'Skeleton of the diet parameter file generated 
             by `create.rpath.param` function')
```

Individual diet components can be adjusted by specifying the prey in the 'Group'
variable and assigning the value to the predator.  For example, if you wanted to
assign 10% of the seabird diet as 'Other Groundfish' you could do it like this:

```{r how to fill diet 1}
dietfile <- dietfile[Group == 'OtherGroundfish', Seabirds := 0.1]
```

You can also assign the entire diet composition for a predator:

```{r how to fill diet 2}
whale.diet <- c(rep(NA, 3), 0.01, NA, 0.01, NA, 0.01, NA, 0.01, rep(NA, 4), 0.1,
                rep(NA, 3), 0.86, rep(NA, 3))
dietfile <- dietfile[, Whales := whale.diet]
```
```{r Dietfile table partial, echo = F}
knitr::kable(dietfile[, list(Group, Seabirds, Whales)])
```

Here is the completed model parameter file for R Ecosystem:

```{r diet fill}
seabird.diet <- c(rep(NA, 11), 0.1, 0.25, 0.2, 0.15, rep(NA, 6), 0.3)
seal.diet    <- c(rep(NA, 3), 0.05, 0.1, 0.05, 0.2, 0.005, 0.05, 0.005, 0.01, 0.24, 
                  rep(0.05, 4), 0.09, rep(NA, 5))
juvrf.diet   <- c(rep(NA, 3), rep(c(1e-4, NA), 4), 1e-3, rep(NA, 2), 0.05, 1e-4,
                  NA, .02, .7785, .1, .05, NA)
rf1.diet     <- c(rep(NA, 5), 1e-3, 0.01, 1e-3, 0.05, 1e-3, 0.01, 0.29, 0.1, 0.1,
                  0.347, 0.03, NA, 0.05, 0.01, rep(NA, 3))
rf2.diet     <- c(rep(NA, 3), 1e-4, NA, 1e-4, NA, rep(1e-4, 4), 0.1, rep(0.05, 3),
                  0.2684, 0.01, 0.37, 0.001, NA, 0.1, NA)
juvff.diet   <- c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 3), rep(1e-4, 2), NA,
                  0.416, 0.4334, 0.1, 0.05, NA)
ff1.diet     <- c(rep(NA, 7), rep(1e-4, 5), rep(NA, 2), 0.001, 0.05, 0.001, 0.6, 
                  0.2475, NA, 0.1, NA)
ff2.diet     <- c(rep(NA, 7), 1e-4, NA, 1e-4, rep(NA, 4), rep(1e-4, 3), 0.44, 0.3895,
                  NA, 0.17, NA)
ogf.diet     <- c(rep(NA, 3), rep(1e-4, 8), 0.05, 0.08, 0.0992, 0.3, 0.15, 0.01,
                  0.3, 0.01, rep(NA, 3))
forage.diet  <- c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 7), 0.8196, 0.06, 0.12, NA)
megaben.diet <- c(rep(NA, 15), 0.1, 0.03, 0.55, rep(NA, 2), 0.32, NA)
shell.diet   <- c(rep(NA, 18), 0.3, 0.5, 0.2, NA)
macro.diet   <- c(rep(NA, 16), 0.01, rep(0.2, 2), NA, 0.59, NA)
zoo.diet     <- c(rep(NA, 18), 0.2, 0.6, 0.2, NA)

dietfile <- dietfile[, Seabirds        := seabird.diet]
dietfile <- dietfile[, Seals           := seal.diet]
dietfile <- dietfile[, JuvRoundfish1   := juvrf.diet]
dietfile <- dietfile[, AduRoundfish1   := rf1.diet]
dietfile <- dietfile[, JuvRoundfish2   := juvrf.diet]
dietfile <- dietfile[, AduRoundfish2   := rf2.diet]
dietfile <- dietfile[, JuvFlatfish1    := juvff.diet]
dietfile <- dietfile[, AduFlatfish1    := ff1.diet]
dietfile <- dietfile[, JuvFlatfish2    := juvff.diet]
dietfile <- dietfile[, AduFlatfish2    := ff2.diet]
dietfile <- dietfile[, OtherGroundfish := ogf.diet]
dietfile <- dietfile[, Foragefish1     := forage.diet]
dietfile <- dietfile[, Foragefish2     := forage.diet]
dietfile <- dietfile[, OtherForagefish := forage.diet]
dietfile <- dietfile[, Megabenthos     := megaben.diet]
dietfile <- dietfile[, Shellfish       := shell.diet]
dietfile <- dietfile[, Macrobenthos    := macro.diet]
dietfile <- dietfile[, Zooplankton     := zoo.diet]

```
```{r Dietfile Table, echo = F}
knitr::kable(dietfile, caption = 'Diet parameter file for R Ecosystem')
```

Just like the model parameter file, there is the option to save the parameter 
file by passing a name to the "filename" argument.

#### Juvenile parameter file

Rpath is currently set up to only handle adult and juvenile stanzas.  We expect 
to expand this capability to multi-stanzas in the near future.  If your model
does not have any groups with stanzas, you still need to generate a juvenile
parameter file.  The easiest way to do this is to call the `create.rpath.param`
function without any groups specified.

```{r empty juvfile}
juvfile <- create.rpath.param(parameter = 'juvenile')
```
```{r empty juvfile table, echo = F}
knitr::kable(juvfile, caption = 'Juvenile parameter file created without any
             multi-stanza groups')
```

If your model does have groups with stanzas, generate a juvenile parameter file 
and set the 'group' argument to a vector of stanza group names (i.e. the Multi-
stanza group name from EwE).

```{r juvfile with groups}
juvfile <- create.rpath.param(parameter = 'juvenile', 
                              group = c('Roundfish1', 'Roundfish2', 'Flatfish1', 
                                        'Flatfish2'))
```
```{r blank juvfile table, echo = F}
knitr::kable(juvfile, caption = 'Juvenile parameter file created with stanza groups')
```

The parameters in this file can be a bit confusing.  The first parameters are the
JuvNum and AduNum. These refer to their position in the model and diet parameter
files for the juveniles and adults respectively.  The easiest way to figure this
out is to use the `which` command on your vector of group names.

```{r group numbers, results = 'hold'}
#Roundfish1
cat('JuvRoundfish1:')
which(groups == 'JuvRoundfish1')
cat('AduRoundfish1:')
which(groups == 'AduRoundfish1')
```

The next two parameters, RecAge and RecMonth, effect how biomass flows between 
the two stanzas.  RecAge, measured in years, determines when to advance the biomass
from the juvenile stanza to the adult stanza. While RecMonth is the numeric 
representation of the month when spawning occurs.  If set to zero, spawning is 
assumed to happen throughout the year (zero should be the default assumption).

Growth in Rpath is modeled using the "generalized" von Bertalanffy growth function
(VBGF; Essington et al. 2001^[Essington et al. 2001. The von Bertalanffy growth
function, bioenergetics, and the consumption rates of fish. Canadian Journal of 
Fisheries and Aquatic Sciences 58:2129-2138]).  However, the "specialized" 
version of the equation is more commonly used in fisheries.  For this reason, the
VonBK parameter in the parameter file is the the "specialized"" von Bertalanffy 
growth coefficient, k. This is consistent with the inputs for EwE. Rpath multiplies 
this value by 3 when supplying it to the "generalized" VBGF. In addition, the 
"specialized" VBGF is simplified from the "generalized" VBGF by assuming that 
consumption rates scale with body size to the 2/3 power (Essington et al. 2001).
Because Rpath uses the "generalized" VBGF, this can be changed by specifying
a value other than 0.6667 for the VonBD parameter.  By default, `create.rpath.param`
populates the VonBD variable with 0.6667.

The juvenile parameter file also contains total mortality parameters for the two
stanzas, AduZ_BAB and JuvZ_BAB.  Total mortality can be estimated using the PB 
ratio.  Note that if the PB value and Z_BAB value are different, Rpath will use the 
difference as a biomass accumulation term.  This can lead to strange behavior in the 
model.

The remaining parameters are related to the growth curve.  Wmat50, Wmat001, Amat50,
and Amat001 are a ratio of the weight (W) or age (A) at 50% (50) or first (001)
maturity to the asymptotic weight/age.  Setting Amat001 to -1000000 effectively 
turns that parameter off in the model (default assumption).  The final parameter 
is the recruitment power (RecPower).  This is defaulted to 1 (no effect).  This 
can be used to create non-linear effects of food consumption rate on recruitment 
per adults (Walter et al. 2000^[Walters et al. 2000. Representing density dependent
consequences of life history strategies in aquatic ecosystems: EcoSim II. 
Ecosystems 3:70-83]).

Here is the completed juvfile for R Ecosystem:

```{r fill juvfile}
juvfile <- juvfile[, JuvNum := c(4, 6, 8, 10)]
juvfile <- juvfile[, AduNum := c(5, 7, 9, 11)]
juvfile <- juvfile[, RecAge := c(rep(2, 3), 4)]
juvfile <- juvfile[, RecMonth := rep(0, 4)]
juvfile <- juvfile[, VonBK := c(0.145, 0.295, 0.076, 0.112)]
juvfile <- juvfile[, AduZ_BAB := c(0.42, 0.425, 0.26, 0.18)]
juvfile <- juvfile[, JuvZ_BAB := c(2.026, 2.1, 1.5, 1.1)]
juvfile <- juvfile[, Wmat50 := c(0.077, 0.561, 0.117, 0.321)]
juvfile <- juvfile[, Wmat001 := c(0.058, 0.421, 0.088, 0.241)]
juvfile <- juvfile[, Amat50 := c(rep(4, 3), 8)]
juvfile <- juvfile[, Amat001 := rep(-1000000, 4)]
```
```{r juvfile table, echo = F}
knitr::kable(juvfile, caption = 'Juvenile parameter file for R Ecosystem')

```

#### Pedigree parameter file

Rpath does not currently use pedigrees however, future Rpath extensions will use
them.  Therefore we provide a means of creating a pedigree parameter file.  The
default values are 1 (low confidence).  These defaults are not changed for R
Ecosystem but can obviously be changed in a similar manner to the other parameter
files.

```{r pedigree creation}
pedfile <- create.rpath.param(parameter = 'pedigree', group = groups, type = types)
```
```{r pedigree table, echo = F}
knitr::kable(pedfile, caption = 'Pedigree parameter file for R Ecosystem')
```

## Running Ecopath

After creating the parameter files, running ecopath in R is relatively 
straightforward.  It is just the function `ecopath` supplied with the model and
diet parameter files.  The arguments modfile and dietfile can be either the R 
objected created above or a file path to saved parameter files.  Additionally, 
you can supply an ecosystem name for the output.

```{r Running ecopath}
REco <- ecopath(modfile, dietfile, eco.name = 'R Ecosystem')
REco
```

The output object from `ecopath` is an S3 object type called 'Rpath'.  Rpath objects
are a list of parameters from the mass balance.  However, the `print` function will
display the same information as the "Basic Estimates" tab from EwE. You will also 
notice that the `print` function will display whether the model is balanced or not.
If the model was not balanced, it would list the groups that are not balanced.

You can also display the mortalities associated with each group by supplying the
argument `morts = T` to the `print` function.

```{r Ecopath morts}
print(REco, morts = T)
```

Note that if you wish to save the `print` output you need to use the function
`write.rpath`.  This function will also accept the argument 'morts = T'.

The generic function `summary` will display some summary statistics on the model
as well as a list of attributes you can access.  To access any of the other 
attributes simply use the standard list notation.

```{r Ecopath summaries}
summary(REco)
REco$TL
```

One of the advantages of R is its graphical ability.  Users can feel free to develop
their own graphical routines for the Rpath outputs.  However, we have included
a basic food web plot.  The routine can include fisheries, display group numbers or 
names, and even highlight a particular group.

```{r Food Web Plots, fig.align = 'center', fig.height = 7, fig.width = 7}
webplot(REco)
webplot(REco, labels = T)
webplot(REco, fleets = T, highlight = 'AduRoundfish1')
```

## Running Ecosim

Running the dynamic simulation model, ecosim, is a two part process.  The first
part initializes the model for ecosim.  The function `ecosim.init` is actually a
conglomerate of three functions: `ecosim.rates`, `ecosim.stanzas`, and `ecosim.pack`.
More advance users may wish to explore the flexibility of Rpath and adjust some
of the default parameters, however for this vignette we are sticking with the default
parameterization of ecosim.  The function `ecosim.stanzas` requires a juvenile
parameter file to run.  So even if you do not have any groups with adult and 
juvenile stanzas you need to supply a juvfile.  This can be passed as an argument
to `ecosim.init`.  Another variable that must be passed to `ecosim.init` is the number
of years for the simulation.

```{r Ecosim init}
REco.init <- ecosim.init(REco, juvfile, years = 100)
```

The second part of the ecosim process is the function `ecosim.run`.  We recommend
making a copy of the Rpath.sim.init object before running `ecosim.run`.  Otherwise
`ecosim.run` will change the initial starting conditions.  Other arguments passed to
`ecosim.run` include the beginning year (BY) and ending year (EY).  You can also 
indicate if this is the initial run or a perturbation.  This will make sense in the
second example.  But first, here is a 100 year run at equilibrium.

```{r ecosim equilibrium run}
REco.base <- data.table::copy(REco.init)
REco.base <- ecosim.run(REco.base, 0, 100)
```

The output from `ecosim.run` is another S3 object class called 'Rpath.sim'.  Similar
to the Rpath object created by `ecopath`, the generic function `print` will give
output similar to the 'Ecosim results' tab in EwE. If you want to save the `print`
results you need to use the function `write.rpath.sim`.  The function `summary` just
like for the Rpath object will display what other list items are available.

```{r ecosim print}
REco.base
summary(REco.base)
```

Just like with `ecopath`, we have included a quick graphical routine for plotting
biomass trajectories over time.  Other plots similar to the group plots are possible
but at this time we do not have a built-in function.

```{r ecosim equilibrium plot, fig.height = 7, fig.width = 7}
ecosim.plot(REco.base)
```

Obviously running a model at equilibrium is not very exciting.  There are a number
of ways to perturb the system.  Below is an example using a function we developed
that adjusts the fishing mortality rate on a group.  Other adjustments might need
to be done by hand but please feel free to suggest common adjustments that are 
made and we can develop a tool.

```{r ecosim adjustment 1}
#Increase F on Adult roundfish 1
REco.rf1 <- data.table::copy(REco.init)

#Run an initial burn-in period
REco.rf1 <- ecosim.run(REco.rf1, 0, 25)
```
```{r ftable1, eval = F}
#Look at initial F rates
frate.table(REco.rf1)
```
```{r ftable2, echo = F}
knitr::kable(frate.table(REco.rf1), caption = 'Original F rates for R Ecosystem')
```
```{r ecosim adjustment 2}
#Double F by all gears
REco.rf1 <- frate.adjust(REco.rf1, 'AduRoundfish1', 'Trawlers', 2)
REco.rf1 <- frate.adjust(REco.rf1, 'AduRoundfish1', 'Midwater', 2)
REco.rf1 <- frate.adjust(REco.rf1, 'AduRoundfish1', 'Dredgers', 2)
```
```{r ftable3, eval = F}
#Look at new F rates
frate.table(REco.rf1)
```
```{r ftable4, echo = F}
knitr::kable(frate.table(REco.rf1), caption = 'New F rates for R Ecosystem')
```
```{r ecosim adjustment3, fig.height = 7, fig.width = 7}
#Run the model from the initial burn-in
#Notice the init_run = F argument
REco.rf1 <- ecosim.run(REco.rf1, 25, 100, init_run = F)

#Plot pertubations
ecosim.plot(REco.rf1)
```



